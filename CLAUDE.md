# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a multi-location homelab infrastructure project using Infrastructure as Code principles. The project manages three distinct locations:
- **Homelab**: Main location with Proxmox cluster and Docker Swarm
- **Internet-VPS**: 3 VPS servers for external connectivity and VPN mesh
- **CamperVan**: Mobile setup with Raspberry Pi

## Key Architecture

The project follows an Infrastructure as Code approach with Ansible as the primary automation tool. All infrastructure is defined declaratively and can be completely rebuilt from code.

**Location Architecture:**
- VPN mesh connects all three locations through Internet-VPS servers
- No direct port forwarding to homelab/campervan (security principle)
- Centralized DNS with internal/external split
- Standardized on Debian Bookworm across all locations

**Technology Stack:**
- **Infrastructure**: Ansible playbooks with encrypted vaults
- **Networking**: VPN mesh (Pangolin/Headscale), Traefik reverse proxy
- **DNS**: Pi-hole on Raspberry Pi with redundancy
- **Monitoring**: Centralized monitoring from homelab

## Common Development Commands

**Initial Setup:**
```bash
# Initialize Ansible environment and install dependencies
./scripts/setup/bootstrap_ansible.sh
```

**Deployment Commands (run from ansible/ directory):**
```bash
# Deploy complete infrastructure
make deploy-all

# Deploy specific locations
make deploy-homelab
make deploy-vps
make deploy-campervan

# Deploy specific services
make deploy-traefik    # Reverse proxy
make deploy-dns        # DNS infrastructure
make deploy-vpn        # VPN servers

# Dry-run before deployment
make check

# Validate Ansible configuration
make lint
```

**Maintenance Commands:**
```bash
# System health check across all locations
./scripts/monitoring/health_check.sh

# Edit encrypted secrets
make vault-edit        # (from ansible/ directory)

# Test Ansible connectivity
ansible all -m ping    # (from ansible/ directory)
```

**Linting and Validation:**
```bash
cd ansible/
ansible-lint playbooks/
yamllint inventory/ playbooks/ roles/
```

## Repository Structure

- `ansible/`: Infrastructure as Code with Ansible
  - `playbooks/`: Location-specific deployment playbooks
  - `roles/`: Reusable service roles (common, traefik, pihole, etc.)
  - `inventory/`: Host definitions and group variables
  - `vault/`: Encrypted secrets with ansible-vault
- `scripts/`: Standalone automation scripts for setup/maintenance
- `docs/`: Technical documentation
- `project-knowledge/`: Archived planning documents and design decisions

## Working with Ansible

**Configuration:**
- Default inventory: `inventory/production`
- Vault password file: `.ansible-vault-pass` (generated by bootstrap script)
- SSH key authentication only (no password auth)

**Deployment Strategy:**
1. Deploy VPS infrastructure first (`make deploy-vps`)
2. Deploy homelab base services (`make deploy-homelab`)
3. Deploy additional services by tags
4. Deploy campervan last (`make deploy-campervan`)

**Vault Management:**
- Secrets are encrypted with ansible-vault
- Use `make vault-edit` to modify encrypted files
- Never commit unencrypted secrets

## Service Architecture

**Multi-location Services:**
- Each role is designed to work across different locations
- Location-specific variables in `inventory/group_vars/`
- Services communicate through VPN mesh
- Traefik provides SSL termination with Let's Encrypt

**Key Roles:**
- `common`: Base system configuration for all hosts
- `vpn-client/vpn-server`: VPN mesh connectivity
- `traefik`: Reverse proxy with automatic SSL
- `pihole`: DNS filtering and internal resolution
- `docker-swarm`: Container orchestration
- `home-assistant`: Home automation platform

## Security Model

- No direct internet exposure for homelab/campervan
- VPN-only access through Internet-VPS servers
- SSH key authentication with dedicated ansible user
- Encrypted storage of all secrets and API keys
- Network segmentation in homelab (standard/IoT/guest VLANs)